= SILO API

image:https://badges.gitter.im/ngageoint/seed.svg[link="https://gitter.im/ngageoint/seed?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge&utm_content=badge"]
image:https://travis-ci.org/ngageoint/seed-silo.svg?branch=master[link="https://travis-ci.org/ngageoint/seed-silo"]

SILO (Seed Images Location Operation) is a REST API provided by the Seed team for discovering Seed images.  The API
allows users to scan one or more repositories for seed images and then search the resulting images and their manifests
by keywords.  Frameworks such as Scale can use these endpoints to assist users in finding algorithm images and creating
jobs out of them.

== Install

To build/install the SILO webapp on linux:

----
Install go and docker packages
yum install go
yum install docker
go get github.com/ngageoint/seed-silo
~/go/src/github.com/ngageoint/seed-silo/install-silo.sh
----

== Usage

=== Registry

Registries can be added, deleted and scanned. A registry consists of a name, url, organization (optional), username (optional),
and password (optional).

==== Get Registry

Retrieves a registry

[cols="h,5a"]
|===
| URL
| /registry/{id}

| Method
| GET

| URL Params
| id = integer

| Data Params
| None

| Success Response
|       Code: 200 +
        Content: {"ID":1,"Name":"dockerhub","Url":"https://hub.docker.com","Org":"johnptobe","Username":"","Password":""}

|Error Response
|       Code: 400 Bad Request +
        Content: { error : "Invalid ID" } +
        Code: 404 File not found +
        Content: { error : "No registry found with that ID" }

|Sample Call
| curl -X "GET" http://localhost:9000/registry/1
|===

==== Add Registry

Adds a registry to the list of registries to be scanned.  An error will be returned and the registry won't be added if
the daemon is unable to connect to the registry.

[cols="h,5a"]
|===
| URL
| /registry/add

| Method
| POST

| URL Params
| None

| Data Params
| {"name":"localhost", "url":"https://localhost:5000", "org":"", "username":"testuser", "password": "testpassword"}

| Success Response
|       Code: 201 +
       Content: {}

|Error Response
|       Code: 400 Bad Request +
        Content: { error : "Unable to connect to registry" } +
         +
        OR +
         +
        Code: 422 Unprocessable Entity +
        Content: { error : "Error unmarshalling json. " }

|Sample Call
| curl -H "Content-Type: application/json" -d '{"name":"localhost", "url":"https://localhost:5000", "org":"", "username":"testuser", "password": "testpassword"}' http://localhost:9000/registry/add
|===

==== Delete Registry

Removes a registry from the list of registries along with all images associated with that registry.

[cols="h,5a"]
|===
| URL
| /registry/delete/{id}

| Method
| DELETE

| URL Params
| id = integer

| Data Params
| None

| Success Response
|       Code: 200 +
        Content: { }

|Error Response
|       Code: 400 Bad Request +
        Content: { error : "Invalid ID" }

|Sample Call
| curl -X "DELETE" http://localhost:9000/registry/delete/1
|===

==== Scan Registries

Removes all existing image entries, scans all registries for seed images and adds them to the database.
Requires admin authorization token

[cols="h,5a"]
|===
| URL
| /registries/scan

| Method
| GET

| URL Params
| None

| Data Params
| None

| Success Response
|       Code: 202 +
        Content: { } +
        Code: 202 +
        Content: {"message":"Scanning Registries"}

|Error Response
|       Code: 401 Unauthorized +
        Content: { error : "Invalid authorization token" } or { error : "Missing authorization token" } +
        Code: 403 Forbidden +
        Content: { error : "User does not have permission to perform this action" }

|Sample Call
| curl -H "Authorization: Token <token>" "https://localhost:9000/registries/scan"
|===

==== Scan Registry

Removes all existing image entries, scans all registries for seed images and adds them to the database.
Requires admin authorization token

[cols="h,5a"]
|===
| URL
| /registry/{id}/scan

| Method
| GET

| URL Params
| id = integer

| Data Params
| None

| Success Response
|       Code: 202 +
        Content: { } +
        Code: 202 +
        Content: {"message":"Scanning Registries"}

|Error Response
|       Code: 401 Unauthorized +
        Content: { error : "Invalid authorization token" } or { error : "Missing authorization token" } +
        Code: 403 Forbidden +
        Content: { error : "User does not have permission to perform this action" }

|Sample Call
| curl -H "Authorization: Token <token>" "https://localhost:9000/registry/1/scan"
|===

==== List Registries

Retrieves all of the registries that have been successfully added

[cols="h,5a"]
|===
| URL
| /registries

| Method
| GET

| URL Params
| None

| Data Params
| None

| Success Response
|       Code: 200 +
        Content: [ +
                   { +
                     "ID": 1, +
                     "Name": "localhost", +
                     "Url": "https://localhost:5000", +
                     "Org": "", +
                     "Username": "", +
                     "Password": "" +
                   } +
                 ]

|Error Response
|       None

|Sample Call
| curl "https://localhost:9000/registries"
|===

=== Image

Images are added/removed by scanning registries. An image consists of a name, registry, organization (optional), and the
Seed manifest.

==== List Images

Retrieves all of the Seed images that have been scanned from registries

[cols="h,5a"]
|===
| URL
| /images

| Method
| GET

| URL Params
| None

| Data Params
| None

| Success Response
|       Code: 200 +
        Content: [ +
                   { +
                     "ID": 3, +
                     "RegistryId": 1, +
                     "Name": "my-job-0.1.0-seed:0.1.0", +
                     "Registry": "localhost:5000", +
                     "Org": "", +
                     "Manifest": "{\"seedVersion\":\"0.1.0\",\"job\":{\"name\":\"my-job\",...}}" +
                   }, +
                   { +
                     "ID": 4, +
                     "RegistryId": 2, +
                     "Name": "my-job-0.1.0-seed:0.1.0", +
                     "Registry": "localhost:5000", +
                     "Org": "", +
                     "Manifest": "{\"seedVersion\":\"0.1.0\",\"job\":{\"name\":\"my-job\",...}}" +
                   } +
                 ]

|Error Response
|       None

|Sample Call
| curl "https://localhost:9000/images"
|===

==== Search Images

Searches the Seed images that have been scanned from registries and returns images matching the given query.  Images are
returned if the name, organization or manifest strings match the given query.

[cols="h,5a"]
|===
| URL
| /images/search/{query}

| Method
| GET

| URL Params
| query = string

| Data Params
| None

| Success Response
|       Code: 200 +
        Content: [ +
                   { +
                     "ID": 3, +
                     "RegistryId": 1, +
                     "Name": "my-job-0.1.0-seed:0.1.0", +
                     "Registry": "localhost:5000", +
                     "Org": "", +
                     "Manifest": "{\"seedVersion\":\"0.1.0\",\"job\":{\"name\":\"my-job\",...}}" +
                   }, +
                   { +
                     "ID": 4, +
                     "RegistryId": 2, +
                     "Name": "my-job-0.1.0-seed:0.1.0", +
                     "Registry": "localhost:5000", +
                     "Org": "", +
                     "Manifest": "{\"seedVersion\":\"0.1.0\",\"job\":{\"name\":\"my-job\",...}}" +
                   } +
                 ]

|Error Response
|       None

|Sample Call
| curl "https://localhost:9000/images/search/test"
|===

==== Get Image

Retrieves an image

[cols="h,5a"]
|===
| URL
| /images/{id}

| Method
| GET

| URL Params
| id = integer

| Data Params
| None

| Success Response
|       Code: 200 +
        Content: +
                   { +
                     "ID": 3, +
                     "RegistryId": 1, +
                     "Name": "my-job-0.1.0-seed:0.1.0", +
                     "Registry": "localhost:5000", +
                     "Org": "", +
                     "Manifest": "{\"seedVersion\":\"0.1.0\",\"job\":{\"name\":\"my-job\",...}}" +
                   }

|Error Response
|       Code: 400 Bad Request +
        Content: { error : "Invalid ID" } +
        Code: 404 File not found +
        Content: { error : "No image found with that ID" }

|Sample Call
| curl -X "GET" http://localhost:9000/images/1
|===

==== Image Manifest

Returns the Seed manifest json for the given image id.

[cols="h,5a"]
|===
| URL
| /images/{id}/manifest

| Method
| GET

| URL Params
| id = integer

| Data Params
| None

| Success Response
|       Code: 200 +
        Content: link:seed.manifest.json[sample manifest]

|Error Response
|       Code: 400 Bad Request +
        Content: { error : "Invalid ID" } +
        Code: 404 File not found +
        Content: { error : "No image found with that ID" }

|Sample Call
| curl "https://localhost:9000/images/1/manifest"
|===

=== User

Users can be added, deleted, listed and used to login. A user consists of a username, password, and a role.

==== Get User

Retrieves a user

[cols="h,5a"]
|===
| URL
| /registry/{id}

| Method
| GET

| URL Params
| id = integer

| Data Params
| None

| Success Response
|       Code: 200 +
        Content: {"ID":1,"username":"admin","role":"admin"}

|Error Response
|       Code: 400 Bad Request +
        Content: { error : "Invalid ID" } +
        Code: 404 File not found +
        Content: { error : "No user found with that ID" }

|Sample Call
| curl -X "GET" http://localhost:9000/user/1
|===

==== Add User

Adds a user to the system.  Requires a valid token from an admin user.

[cols="h,5a"]
|===
| URL
| /user/add

| Method
| POST

| URL Params
| None

| Data Params
| {"username":"admin", "password": "hunter17", "role": "admin"}

| Success Response
|      Code: 201 +
       Content: {"username":"admin", "password": "hunter17", "role": "admin"}

|Error Response
|       Code: 401 Unauthorized +
        Content: { error : "Invalid authorization token" } or { error : "Missing authorization token" } +
        Code: 403 Forbidden +
        Content: { error : "User does not have permission to perform this action" } +
        Code: 422 Unprocessable Entity +
        Content: { error : "Error unmarshalling json. " }

|Sample Call
|curl -H "Content-Type: application/json" -d '{"username":"admin", "password": "hunter17", "role": "admin"}' -H "Authorization: Token <token>" http://localhost:9000/user/add
|===

==== Delete User

Removes a user from the system.  Requires a valid token from an admin user.

[cols="h,5a"]
|===
| URL
| /user/delete/{id}

| Method
| DELETE

| URL Params
| id = integer

| Data Params
| None

| Success Response
|       Code: 200 +
        Content: { }

|Error Response
|       Code: 400 Bad Request +
        Content: { error : "Invalid ID" } +
        Code: 401 Unauthorized +
        Content: { error : "Invalid authorization token" } or { error : "Missing authorization token" } +
        Code: 403 Forbidden +
        Content: { error : "User does not have permission to perform this action" }

|Sample Call
| curl -X "DELETE" -H "Authorization: Token <token>" http://localhost:9000/user/delete/1
|===

==== List Users

Retrieves all of the users in the system

[cols="h,5a"]
|===
| URL
| /users

| Method
| GET

| URL Params
| None

| Data Params
| None

| Success Response
|       Code: 200 +
        Content: [ +
                   { +
                     "ID": 1, +
                     "username": "admin", +
                     "role": "admin" +
                   }, +
                   { +
                     "ID": 2, +
                     "username": "user", +
                     "role": "user" +
                   } +
                 ]

|Error Response
|       None

|Sample Call
| curl "https://localhost:9000/users"
|===

==== Login

Authenticates a user and returns a token to be used in subsequent api calls

[cols="h,5a"]
|===
| URL
| /login

| Method
| GET

| URL Params
| None

| Data Params
| {"username":"admin", "password": "password"}

| Success Response
|       Code: 200 +
        Content: {"token":"<token>"}

|Error Response
|       Code: 401 Unauthorized +
        Content: { error : "Invalid login" } +
        Code: 422 Unprocessable Entity +
        Content: { error : "Error unmarshalling json. " }

|Sample Call
| curl -H "Content-Type: application/json" -d '{"username":"admin", "password": "password"}' "https://localhost:9000/login"
|===